FROM ghcr.io/bonsol-collective/bonsol-forge:0.1.1

# Install OpenSSH server
RUN apt-get update && \
    apt-get install -y openssh-server zsh git curl && \
    mkdir /var/run/sshd

# Configure SSH
RUN sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    sed -i 's/#AllowTcpForwarding yes/AllowTcpForwarding yes/' /etc/ssh/sshd_config && \
    sed -i 's/#GatewayPorts no/GatewayPorts yes/' /etc/ssh/sshd_config

# Add your SSH public key to root's authorized_keys
RUN mkdir -p /root/.ssh && \
    chmod 700 /root/.ssh

# ðŸ‘‡ Replace this line with your actual public key
RUN echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDfbstZ88c/dOxgmN6CJDTcQlR3/NJ5cRlx1N7PrYTnpQ3Sf8syIhvi0NeFxE3JS0OuNI97QrWpTZM3f8zoxByPV8XTrmABSz/2TOU+nbzJg0YSwIk9ufoFpxQGPNvULE8GMGZp4gQWuBwBv8e2J4E/V8C18cMPuxaTmlU7yaUGPn+GN0+NFBjaYsy76CYEa9B4lBPaJuo4dAVkVePaAgAVZfHI0GnmEd9Ex5Oti0XXGd17XFjENjjzNJMklOFVJsx5/J/91R9cL/RVh6EcOYrRQbnLsmo1E+2ERWhXAXVExrzPJpBq4HibxBRITXTm+Yf0WuFKaPXXMh7lxFGrnOd8l7fKBzbThEkGBWyyDoUzzdutUnjeHvCdhLGiD+PppiTJlak2tzoxmC9qilJDAmkydvMqq4l9xo1K+WVEj3QFrhnQLXmk1WdBySvUZhqTZnbnL2lorwEH9It936j5V9IF8TwCGEdHwfFoXGFJsBXY/Umodfah4+WVWFV+qqwUjj9Ecj4OK184J8D8bWleSNk8D0e8IXAlJgDBBpVeS4HukG/fRg6IpXaJUXhGSVnQgdQWCoICN5Wf1ur19oObLgFxwStfurlidhG2fmpkSWQtw8Kj7/B9pRKibSKqXe81WHxiGbeFxf6YgLhJBavKerOzK9B2wwHk0zas8qlzk/PcmQ== cardno:10_114_737" > /root/.ssh/authorized_keys && \
    chmod 600 /root/.ssh/authorized_keys

# Make zsh the default shell for root
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" && \
    sed -i 's/^ZSH_THEME=.*/ZSH_THEME="agnoster"/' /root/.zshrc && \
    chsh -s /usr/bin/zsh root

# Append requested environment setup to zshrc
RUN cat <<'EOF' >> /root/.zshrc

# Toolchains and runtime managers
. "$HOME/.cargo/env"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# Solana and Cuda PATH
export PATH="/usr/local/cuda/bin:$HOME/.local/share/solana/install/active_release/bin:$PATH"
EOF

ENV SHELL=/usr/bin/zsh

# Expose SSH port
EXPOSE 2222

# Run SSH daemon in foreground
CMD ["/usr/sbin/sshd", "-D"]

