name: Pull request workflow

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  packages: read

jobs:

  check_pre-commit:

    name: Run pre-commit checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit in check mode
        run: pre-commit run --all-files

  check-formatting:

    name: Check & Format
    runs-on: ubicloud-standard-16

    container:
      image: ghcr.io/bonsol-collective/bonsol-ci-env:1.0.0
      volumes:
        - local:/workspaces/bonsol
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check
        shell: bash
        id: check
        run: |
          cargo check
      - name: Fmt
        shell: bash
        id: fmt
        run: |
          cargo +nightly fmt --all -- --check

  unit-tests:

    name: Unit Test
    runs-on: ubicloud-standard-16

    container:
      image: ghcr.io/bonsol-collective/bonsol-ci-env:1.0.0
      volumes:
        - local:/workspaces/bonsol
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Test
        run: cargo test -- --nocapture

  check-fork-pr:
    name: Check if PR is from fork
    runs-on: ubuntu-latest
    outputs:
      is_fork: ${{ steps.check.outputs.is_fork }}
    steps:
      - name: Check if PR is from fork
        id: check
        run: |
          if [[ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "PR is from a fork repository"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "PR is from the same repository"
          fi

  call-build-node-container-image:
    permissions:
      contents: read
      packages: write
    needs: check-fork-pr
    uses: ./.github/workflows/build-node-containers.yaml
    with:
      is_fork: ${{ needs.check-fork-pr.outputs.is_fork == 'true' }}
      quick_test_mode: ${{ needs.check-fork-pr.outputs.is_fork == 'true' }}

  # E2E tests are now run directly in the build-node-container-image job
